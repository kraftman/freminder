console.log("started!");var AWS=require("aws-sdk"),email=require("emailjs"),s3=new AWS.S3,myBucket="testiesddd",myKey="test",express=require("express"),passwordless=require("passwordless"),redisStore=require("passwordless-redisstore"),cookieSession=require("cookie-session"),uuidV4=require("uuid/v4"),bodyParser=require("body-parser"),Redis=require("ioredis"),red=new Redis("redis"),app=express();app.use(cookieSession({name:"session",keys:["mysecretkey"],maxAge:864E5}));app.use(passwordless.sessionSupport());
passwordless.init(new redisStore(6379,"redis"),{skipForceSessionSave:!0});app.use(bodyParser.json());app.use(bodyParser.urlencoded());app.use(passwordless.acceptToken({successRedirect:"/success"}));passwordless.addDelivery(function(b,a,c,d){smtpServer.send({text:"Hello!\nAccess your account here: http://localhost:80?token="+b+"&uid="+encodeURIComponent(a),from:"me@itschr.is",to:c,subject:"Token for localhost:80"},function(a,b){a&&console.log(a);d(a)})});
app.get("/test.html",function(b,a){s3.getObject({Bucket:"tannertest",Key:"test.txt"},function(b,d){b?(console.log(b,b.stack),a.send("")):(a.type("text/html"),a.send(d.Body))})});app.listen(80,function(){console.log("Example app listening on port 80!")});app.get("/",function(b,a){b.user?a.send("you are logged in, ID:  "+b.user):a.send("you are not logged in")});app.get("/success",function(b,a){a.send("successfully logged in!")});app.get("/logout",passwordless.logout(),function(b,a){a.redirect("/")});
app.get("/admin",passwordless.restricted(),function(b,a){a.send(b.user)});var smtpServer=email.server.connect({user:"me@itschr.is",password:process.env.GMAIL_OTP,host:"smtp.gmail.com",ssl:!0});app.get("/login",function(b,a){a.send('<html>\n       <body>\n           <h1>Login</h1>\n           <form action="/sendtoken" method="POST">\n               Email:\n               <br><input name="user" type="text">\n               <br><input type="submit" value="Login">\n           </form>\n       </body>\n   </html>\n')});
var users=[{id:1,email:"me@itschr.is"},{id:2,email:"alice@example.com"}];function GetUser(b,a,c,d){red.get("email:"+b).then(function(a){a?console.log(a):(a=uuidV4(),red.set("email:"+b,a).then(red.hset("user:"+a,email,b)));c(null,a)})["catch"](function(a){console.log("error getting from redis: ",a);c(null,null)})}app.post("/sendtoken",passwordless.requestToken(GetUser),function(b,a){a.send("sent")});
